name: integration-tests

on:
  workflow_call:
    inputs:
      aws-region:
        type: string
        default: us-east-1
      role-to-assume:
        required: true
        type: string
      role-duration-seconds:
        type: number
        default: 3600

jobs:
  # Split tests into parallel shards
  tests:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    strategy:
      fail-fast: false  # Continue other jobs if one fails
      matrix:
        shard: [1, 2, 3, 4]  # 4 parallel jobs
    concurrency:
      group: integration-tests-shard-${{ matrix.shard }}-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      # Cache Poetry dependencies
      - name: Cache Poetry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            .venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'poetry'

      - name: Install dependencies
        run: poetry install --no-interaction --all-extras

      - name: Assume AWS role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ inputs.role-to-assume }}
          role-session-name: GHA-shard-${{ matrix.shard }}-${{ github.run_id }}
          role-duration-seconds: ${{ inputs.role-duration-seconds }}

      # Get list of features and shard them
      - name: Get feature files for this shard
        id: features
        run: |
          features=(integration-tests/features/*.feature)
          total=${#features[@]}
          per_shard=$((($total + 3) / 4))  # Divide by 4 shards, round up
          start=$(((matrix.shard - 1) * per_shard))
          end=$((start + per_shard))
          shard_features="${features[@]:$start:$per_shard}"
          echo "features=$shard_features" >> $GITHUB_OUTPUT
        env:
          matrix.shard: ${{ matrix.shard }}

      - name: run tests
        run: |
          for feature in ${{ steps.features.outputs.features }}; do
            poetry run behave "$feature" --junit --junit-directory build/behave/shard-${{ matrix.shard }}
          done
        env:
          AWS_DEFAULT_REGION: eu-west-1
          SCEPTRE_TEST_SHARD: ${{ matrix.shard }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: build/behave/shard-${{ matrix.shard }}
